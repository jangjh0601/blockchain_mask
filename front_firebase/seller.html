<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="./MyFunctions.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
  </script>

  <meta charset="utf-8">
  <title>Seller Page</title>
</head>

<body>
  <div class="container" style="padding-top:20px">
    <form class="form-inline">
      <div class="form-group">
        <label class="sr-only" for="id">id</label>
        <p id="id"></p>
      </div>

    </form>
  </div>
  <h1 class="text-center">판매사 페이지</h1>
  <hr><br>
  <div class="container">
    <div class="accordion text-center" id="accordionExample">
      <div class="card">
        <div class="card-header" id="headingOne">
          <h2 class="mb-0">
            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne"
              aria-expanded="true" aria-controls="collapseOne">
              판매내역
            </button>
          </h2>
        </div>

        <div id="collapseOne" class="collapse show" aria-labelledby="headingOne">
          <div class="card-body">
            <div class="panel panel-default">
              <h1 class="text-center">판매내역</h1>
              <div class=".col-md-6 .col-md-offset-3">
                <div id="table-wrapper" style="height: 300px; overflow-y: scroll;">
                  <table class="table table-hover" id="buyerListTable">
                    <thead>
                      <tr>
                        <th>판매시간</th>
                        <th>일련번호</th>
                        <th>이름</th>
                        <th>주민번호</th>
                        <th>개수</th>
                      </tr>
                    </thead>
                    <tbody id="buyerListTableTBody">
                      <!-- 판매내역 테이블 바디 -->
                    </tbody>
                  </table>
                </div>
                <div class="container" style="margin-bottom:50px">
                  <form class="form-inline">
                    <div class="form-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1">일련번호</span>
                      </div>
                    </div>
                    <input type="text" class="form-control" id="serialNumber3" placeholder="일련번호">
        
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="basic-addon1">개수</span>
                    </div>
        
                    <input type="text" class="form-control" id="count3" placeholder="개수">
        
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="basic-addon1">이름</span>
                    </div>
        
                    <input type="text" class="form-control" id="name" placeholder="이름">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text">주민번호</span>
                      </div>
                      <input type="text" class="form-control" id="civilNumber" placeholder="주민번호"
                        onkeyup="setCivilNumber(this)">
                    </div>
                    <button type="button" class="btn btn-outline-dark" id="checkSales" onclick="SellMask()">확인</button>
                </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header" id="headingTwo">
          <h2 class="mb-0">
            <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo"
              aria-expanded="false" aria-controls="collapseTwo">
              재고내역
            </button>
          </h2>
        </div>
        <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo">
          <div class="card-body">
            <div class="panel panel-default">
              <h1 class="text-center">재고내역</h1>
              <hr>
              <div class=".col-md-6 .col-md-offset-3">
                <div id="table-wrapper" style="height: 300px; overflow-y: scroll;">
                  <table class="table table-hover" id="inventoryTable">
                    <thead>
                      <tr>
                        <th>시간</th>
                        <th>일련번호</th>
                        <th>개수</th>
                      </tr>
                    </thead>
                    <tbody id="inventoryTbody">
        
        
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header" id="headingThree">
          <h2 class="mb-0">
            <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree"
              aria-expanded="false" aria-controls="collapseThree">
              입고내역
            </button>
          </h2>
        </div>
        <div id="collapseThree" class="collapse" aria-labelledby="headingThree">
          <div class="card-body">
            <div class="panel panel-default">
              <h1 class="text-center">입고내역</h1>
              <hr>
              <div class=".col-md-6 .col-md-offset-3">
                <div id="table-wrapper" style="height: 300px; overflow-y: scroll;">
                  <table class="table table-hover" id="receiptHistoryTable">
                    <thead>
                      <tr>
                        <th>시간</th>
                        <th>일련번호</th>
                        <th>유통사</th>
                        <th>판매사</th>
                        <th>개수</th>
                      </tr>
                    </thead>
                    <tbody id="receiptHistoryTbody">
        
        
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <br><br>


  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>
  <script src="./firebaseInit.js"></script>
  <script src="./firebaseUserCheck.js" charset="utf-8"></script>
  <script>
    userSessionCheck();
  </script>
  <script type="text/javascript">
    //재고 목록 테이블 만드는 함수
    function MakeInventoryTable() {

    }
    //입고내역 테이블 만드는 함수
    function MakeReceiptHistoryTable() {
      var myTbody = document.getElementById("receiptHistoryTbody");
      var ourRequest = new XMLHttpRequest();

      ourRequest.open('GET', 'http://localhost:8000/makerhistory/' + userAddr);
      ourRequest.onload = function () {
        var ourData = JSON.parse(ourRequest.responseText);
        console.log(ourData);
        renderMakeReceiptHistoryHTML(ourData);
      };
      ourRequest.send();
    }
    //구매자 리스트 테이블 만드는 함수
    function MakeBuyerListTable() {
      //DB저장하는 함수
      StoreBuyerListInDB();

      //테이블 만들기
      GetDataFromDB()
    }

    function ValidateCivilNumber(civilNumber) {
      if (civilNumber.charAt(6) != "-") {
        return false;
      } else if (civilNumber.length != 14) {
        return false;
      }
      return true;
    }
    //구매자가 구매할 수 있는지 확인하는 함수
    function CanPurchase() {

      var name = document.getElementById('name').value;
      var civilNumber = document.getElementById('civilNumber').value;

      var canPurchase_query = db.collection("observer").doc("purchase_record").collection("record_set").where("name",
        "==", name).where("civilNumber", "==", civilNumber);

      var result = "";

      return canPurchase_query
        .get()
        .then(function (querySnapshot) {
          querySnapshot.forEach(function (doc) {
            // doc.data() is never undefined for query doc snapshots
            result += doc.data().time;
          });
          if (result) {
            console.log("canPurchase", false);
            alert(false);
            return false;
          } else {
            alert(true);
            console.log("canPurchase", true);
            return true;
          }
        })
        .catch(function (error) {
          alert(false);
          console.log("Error getting documents: ", error);
          return false;
        });



    }


    function StoreBuyerListInDB() {
      var serialNumber = document.getElementById("serialNumber3").value;
      var name = document.getElementById("name").value;
      var count = document.getElementById("count3").value;
      var civilNumber = document.getElementById("civilNumber").value;


      //DB에 시리얼넘버, 이름, 개수, 주민번호 넣기
      var docRef = db.collection("users").doc(firebaseEmailAuth.currentUser.uid);
      var docRef2 = db.collection("users").doc(firebaseEmailAuth.currentUser.uid).collection("buyers");
      var docRef3 = db.collection("observer").doc("purchase_record").collection("record_set");
      //로그인된 사용자가 seller인지 확인
      docRef.get().then(function (doc) {
        if (doc.exists) {
          if (doc.data().index != "seller") {
            alert('seller가 아니라면 등록할 수 없습니다! 돌아가세요!');
            return;
          }
          console.log("Document data:", doc.data());
        } else {
          // doc.data() will be undefined in this case
          console.log("No such document!");
          return;
        }
      }).catch(function (error) {
        console.log("Error getting document:", error);
      });

      //어느 칸이라도 비어있으면 안됨
      if (!serialNumber || !name || !count || !civilNumber) {
        alert('제대로 입력해주세요!');
        return;
      }
      //갯수가 0개이상 3개이해
      else if (count < 0 || count >= 3) {
        alert('1인당 3개 이하의 마스크만 구매 가능합니다! 다시 입력해주세요!');
        return;
      }
      //주민번호 유효성
      else if (!ValidateCivilNumber(civilNumber)) {
        alert('주민번호가 유효하지 않습니다.');
        return;
      }
      //전체 구매자 db에 이름, 주민번호가 같은사람이 있을경우 등록 불가
      // else if (!canPurchase) {
      //   alert('이번주에 이미 구매하셨습니다.');
      //   return;
      // }
      CanPurchase().then(function (result) {
        if (!result) {
          alert('이번주에 이미 구매하셨습니다.');
          return;
        } else {
          //해당seller의 db에 저장
          docRef2.add({
              name: name,
              serialNumber: serialNumber,
              count: count,
              civilNumber: civilNumber,
              time: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(function (docRef) {
              console.log("Document written with ID: ", docRef.id);
              alert("seller 저장 완료!");
              setTimeout(GetDataFromDB(), 3000);
            })
            .catch(function (error) {
              console.error("Error adding document: ", error);
              alert("seller 저장 실패!");
            });
          //감사자인 observer db에 저장
          docRef3.add({
              name: name,
              serialNumber: serialNumber,
              count: count,
              civilNumber: civilNumber,
              time: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(function (docRef) {
              console.log("Document written with ID: ", docRef.id);
              alert("observer 저장 완료!");
              setTimeout(GetDataFromDB(), 3000);
            })
            .catch(function (error) {
              console.error("Error adding document: ", error);
              alert("observer 저장 실패!");
            });

        }
      });


    }
    //마스크 판매
    function SellMask() {
      //결과가 ok라면 alert('ok') MakeBuyerListTable(serialNumber,  count,name,civilNumber) else alert('false') return
      //트랜잭션 결과를 리턴받아 result에 저장해야함. 현재는 ok로 놔둠.
      var result = "ok";
      if (result == "ok") {
        alert('트랜잭션 성공');
        MakeBuyerListTable();
      } else {
        alert('트랜잭션 실패');
      }
    }
    //DB로부터 데이터를 가지고옴
    function GetDataFromDB() {
      var docRef = db.collection("users").doc(firebaseEmailAuth.currentUser.uid).collection("buyers");
      docRef.orderBy("time", "desc").get().then(function (querySnapshot) {
        var rowItem = "";
        $('#buyerListTableTBody').empty();
        querySnapshot.forEach(function (doc) {
          //console.log(doc.id, " => ", doc.data());
          // doc.data() is never undefined for query doc snapshots
          rowItem += "<tr><td>" + doc.data().time.toDate().toLocaleString() + "</td>"; /**/
          rowItem += "<td>" + doc.data().serialNumber + "</td>";
          rowItem += "<td>" + doc.data().name + "</td>";
          rowItem += "<td>" + civilNumberEncode(doc.data().civilNumber + "") + "</td>";
          rowItem += "<td>" + doc.data().count + "</td></tr>";

        });
        $('#buyerListTableTBody').append(rowItem);
      });


    }

    function sleep(delay) {
      var start = new Date().getTime();
      while (new Date().getTime() < start + delay);
    }
  </script>
  <script type="text/javascript">
    //인증 시간 지연으로 인해 만듬
    //인증 상태가 변화하면 GetDataFromDB() 함수 호출
    firebase.auth().onAuthStateChanged(function (user) {
      if (user) {
        // User is signed in.
        window.onload = GetDataFromDB();
      } else {
        // No user is signed in.
      }
    });
  </script>
  <script>
    //주민번호 자동 하이픈 기능
    function setCivilNumber(obj) {
      ju = obj.value;
      ju = ju.replace("-", "");
      if (ju.length > 6) {
        ju1 = ju.substring(0, 6);
        ju2 = ju.substring(6, ju.length);

        obj.value = ju1 + "-" + ju2;
      }

    }
  </script>
  <!-- httpRequest JSON parsing script -->
  <script type="text/javascript">
    firebaseEmailAuth.onAuthStateChanged(function (user) {

      if (user) {
        //로그인 성공한 유저 id 확인해 보기 - firebase database에 접근해서 데이터 조회 하는 함수
        var docRef = db.collection("users").doc(firebaseEmailAuth.currentUser.uid);

        docRef.get().then(function (doc) {
          if (doc.exists) {
            userAddr = doc.data().addr;
            userName = doc.data().name;
            userEmail = user.email;
            console.log(user.email + " 님이 로그인했습니다." + " 계좌 : " + userAddr + " 이름 :" + userName);
            MakeReceiptHistoryTable();
            MakeInventoryTable();
          } else {
            // doc.data() will be undefined in this case
            console.log("No such document!");
          }
        }).catch(function (error) {
          console.log("Error getting document:", error);
        });



        //자바스크립트 dom 선택자를 통해서 네비게이션 메뉴의 엘리먼트 변경해주기


        //alert(userInfo.userid);  //uid는 db에서 user 테이블의 각 개체들의 pk 인데, 이 값은 인증에서 생성된 아이디의 pk 값과 같다. *중요!

        return true;
      }
    });
  </script>

  <script>
    function renderMakeReceiptHistoryHTML(data) {
      var htmlString = "";

      for (i = 0; i < data.dealHistory.length; i++) {
        htmlString += "<tr><td>" + new Date(data.dealHistory[i].time * 1000).toLocaleString() + "</td>";
        htmlString += "<td>" + data.dealHistory[i].tokenId + "</td>";
        htmlString += "<td>" + data.dealHistory[i].dealer + "</td>";
        htmlString += "<td>" + data.dealHistory[i].seller + "</td>";
        htmlString += "<td>" + data.dealHistory[i].nnum + "</td></tr>";
      }
      $("#receiptHistoryTbody").append(htmlString);
    }

    function IsSuccessOrFail(data) {
      if (data.status === "fail") {
        alert('실패');
      } else {
        alert('성공');
      }
    }
    //마스크 토큰 없애는 함수. 판매완료됬을때 실행
    function BurnMask() {
      var serialNumber = document.getElementById("serialNumber2").value;
      var toDistributor = document.getElementById("toDistributor").value;
      console.log(serialNumber, toDistributor);
      //위의 변수를 가지고 web3를 통해 컨트랙트 함수 실행
      var ourRequest = new XMLHttpRequest();
      ourRequest.open('GET', 'http://localhost:8000/dealMasks/' + firebaseEmailAuth.currentUser.uid + '/' +
        toDistributor +
        '/' + serialNumber);
      ourRequest.onload = function () {
        var ourData = JSON.parse(ourRequest.responseText);
        console.log(ourData);
        IsSuccessOrFail(ourData);
      };
      ourRequest.send();

    }
  </script>
  </script>
</body>

</html>